"use strict";(self.webpackChunkcosmos_sdk_docs=self.webpackChunkcosmos_sdk_docs||[]).push([[3656],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=u(n),m=a,h=d["".concat(s,".").concat(m)]||d[m]||c[m]||i;return n?r.createElement(h,o(o({ref:t},p),{},{components:n})):r.createElement(h,o({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var u=2;u<i;u++)o[u]=n[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8069:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>u});var r=n(7462),a=(n(7294),n(3905));const i={sidebar_position:1},o="Query Services",l={unversionedId:"building-modules/query-services",id:"version-v0.47/building-modules/query-services",title:"Query Services",description:"A Protobuf Query service processes queries. Query services are specific to the module in which they are defined, and only process queries defined within said module. They are called from BaseApp's Query method.",source:"@site/versioned_docs/version-v0.47/building-modules/04-query-services.md",sourceDirName:"building-modules",slug:"/building-modules/query-services",permalink:"/v0.47/building-modules/query-services",draft:!1,tags:[],version:"v0.47",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Msg Services",permalink:"/v0.47/building-modules/msg-services"},next:{title:"BeginBlocker and EndBlocker",permalink:"/v0.47/building-modules/beginblock-endblock"}},s={},u=[{value:"<code>Querier</code> type",id:"querier-type",level:2},{value:"Implementation of a module query service",id:"implementation-of-a-module-query-service",level:2},{value:"gRPC Service",id:"grpc-service",level:3},{value:"Calling queries from the State Machine",id:"calling-queries-from-the-state-machine",level:3}],p={toc:u};function c(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"query-services"},"Query Services"),(0,a.kt)("admonition",{title:"Synopsis",type:"note"},(0,a.kt)("p",{parentName:"admonition"},"A Protobuf Query service processes ",(0,a.kt)("a",{parentName:"p",href:"/v0.47/building-modules/messages-and-queries#queries"},(0,a.kt)("inlineCode",{parentName:"a"},"queries")),". Query services are specific to the module in which they are defined, and only process ",(0,a.kt)("inlineCode",{parentName:"p"},"queries")," defined within said module. They are called from ",(0,a.kt)("inlineCode",{parentName:"p"},"BaseApp"),"'s ",(0,a.kt)("a",{parentName:"p",href:"/v0.47/core/baseapp#query"},(0,a.kt)("inlineCode",{parentName:"a"},"Query")," method"),".")),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("h3",{parentName:"admonition",id:"pre-requisite-readings"},"Pre-requisite Readings"),(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"/v0.47/building-modules/module-manager"},"Module Manager")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"/v0.47/building-modules/messages-and-queries"},"Messages and Queries")))),(0,a.kt)("h2",{id:"querier-type"},(0,a.kt)("inlineCode",{parentName:"h2"},"Querier")," type"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"querier")," type defined in the Cosmos SDK will be deprecated in favor of ",(0,a.kt)("a",{parentName:"p",href:"#grpc-service"},"gRPC Services"),". It specifies the typical structure of a ",(0,a.kt)("inlineCode",{parentName:"p"},"querier")," function:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go",metastring:"reference",reference:!0},"https://github.com/cosmos/cosmos-sdk/blob/v0.46.0/types/queryable.go#L9\n")),(0,a.kt)("p",null,"Let us break it down:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("a",{parentName:"li",href:"/v0.47/core/context"},(0,a.kt)("inlineCode",{parentName:"a"},"Context"))," contains all the necessary information needed to process the ",(0,a.kt)("inlineCode",{parentName:"li"},"query"),", as well as a branch of the latest state. It is primarily used by the ",(0,a.kt)("a",{parentName:"li",href:"/v0.47/building-modules/keeper"},(0,a.kt)("inlineCode",{parentName:"a"},"keeper"))," to access the state."),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"path")," is an array of ",(0,a.kt)("inlineCode",{parentName:"li"},"string"),"s that contains the type of the query, and that can also contain ",(0,a.kt)("inlineCode",{parentName:"li"},"query")," arguments. See ",(0,a.kt)("a",{parentName:"li",href:"/v0.47/building-modules/messages-and-queries#queries"},(0,a.kt)("inlineCode",{parentName:"a"},"queries"))," for more information."),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"req")," itself is primarily used to retrieve arguments if they are too large to fit in the ",(0,a.kt)("inlineCode",{parentName:"li"},"path"),". This is done using the ",(0,a.kt)("inlineCode",{parentName:"li"},"Data")," field of ",(0,a.kt)("inlineCode",{parentName:"li"},"req"),"."),(0,a.kt)("li",{parentName:"ul"},"The result in ",(0,a.kt)("inlineCode",{parentName:"li"},"[]byte")," returned to ",(0,a.kt)("inlineCode",{parentName:"li"},"BaseApp"),", marshalled using the application's ",(0,a.kt)("a",{parentName:"li",href:"/v0.47/core/encoding"},(0,a.kt)("inlineCode",{parentName:"a"},"codec")),".")),(0,a.kt)("h2",{id:"implementation-of-a-module-query-service"},"Implementation of a module query service"),(0,a.kt)("h3",{id:"grpc-service"},"gRPC Service"),(0,a.kt)("p",null,"When defining a Protobuf ",(0,a.kt)("inlineCode",{parentName:"p"},"Query")," service, a ",(0,a.kt)("inlineCode",{parentName:"p"},"QueryServer")," interface is generated for each module with all the service methods:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"type QueryServer interface {\n    QueryBalance(context.Context, *QueryBalanceParams) (*types.Coin, error)\n    QueryAllBalances(context.Context, *QueryAllBalancesParams) (*QueryAllBalancesResponse, error)\n}\n")),(0,a.kt)("p",null,"These custom queries methods should be implemented by a module's keeper, typically in ",(0,a.kt)("inlineCode",{parentName:"p"},"./keeper/grpc_query.go"),". The first parameter of these methods is a generic ",(0,a.kt)("inlineCode",{parentName:"p"},"context.Context"),", whereas querier methods generally need an instance of ",(0,a.kt)("inlineCode",{parentName:"p"},"sdk.Context")," to read\nfrom the store. Therefore, the Cosmos SDK provides a function ",(0,a.kt)("inlineCode",{parentName:"p"},"sdk.UnwrapSDKContext")," to retrieve the ",(0,a.kt)("inlineCode",{parentName:"p"},"sdk.Context")," from the provided\n",(0,a.kt)("inlineCode",{parentName:"p"},"context.Context"),"."),(0,a.kt)("p",null,"Here's an example implementation for the bank module:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go",metastring:"reference",reference:!0},"https://github.com/cosmos/cosmos-sdk/blob/v0.46.0/x/bank/keeper/grpc_query.go\n")),(0,a.kt)("h3",{id:"calling-queries-from-the-state-machine"},"Calling queries from the State Machine"),(0,a.kt)("p",null,"The Cosmos SDK v0.47 introduces a new ",(0,a.kt)("inlineCode",{parentName:"p"},"cosmos.query.v1.module_query_safe")," Protobuf annotation which is used to state that a query that is safe to be called from within the state machine, for example:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"a Keeper's query function can be called from another module's Keeper,"),(0,a.kt)("li",{parentName:"ul"},"ADR-033 intermodule query calls,"),(0,a.kt)("li",{parentName:"ul"},"CosmWasm contracts can also directly interact with these queries.")),(0,a.kt)("p",null,"If the ",(0,a.kt)("inlineCode",{parentName:"p"},"module_query_safe")," annotation set to ",(0,a.kt)("inlineCode",{parentName:"p"},"true"),", it means:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The query is deterministic: given a block height it will return the same response upon multiple calls, and doesn't introduce any state-machine breaking changes across SDK patch versions."),(0,a.kt)("li",{parentName:"ul"},"Gas consumption never fluctuates across calls and across patch versions.")),(0,a.kt)("p",null,"If you are a module developer and want to use ",(0,a.kt)("inlineCode",{parentName:"p"},"module_query_safe")," annotation for your own query, you have to ensure the following things:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"the query is deterministic and won't introduce state-machine-breaking changes without coordinated upgrades"),(0,a.kt)("li",{parentName:"ul"},"it has its gas tracked, to avoid the attack vector where no gas is accounted for\non potentially high-computation queries.")))}c.isMDXComponent=!0}}]);